name: CI

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Download vdesk.exe and launch provisioner on Desktop 2
      shell: powershell
      run: |
        $vdeskUrl = "https://raw.githubusercontent.com/TreB1e/vdesk-mirror/main/vdesk.exe"
        $vdeskPath = "$env:TEMP\vdesk.exe"

        $attempt = 0
        $maxAttempts = 3
        do {
          try {
            $attempt++
            Invoke-WebRequest -Uri $vdeskUrl -OutFile $vdeskPath -ErrorAction Stop
            Write-Output "vdesk.exe downloaded successfully."
            break
          } catch {
            Write-Output "Attempt $attempt failed. Retrying in 5s..."
            Start-Sleep -Seconds 5
          }
        } while ($attempt -lt $maxAttempts)

        if (-not (Test-Path $vdeskPath)) {
          throw "Failed to download vdesk.exe after $maxAttempts attempts."
        }

        $provisionerPath = "C:\actions\runner-provisioner-Windows\provisioner.exe"

        & $vdeskPath on:2 run:"$provisionerPath" noswitch

        Write-Output "Provisioner launched on Desktop 2 using vdesk."

    - name: Enable Remote Desktop
      shell: powershell
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
        Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force)

    - name: Set Desktop Wallpaper
      shell: powershell
      run: |
        $imgPath = "$env:TEMP\wallpaper.jpg"
        Invoke-WebRequest -Uri 'https://images.unsplash.com/photo-1493246507139-91e8fad9978e?q=80&w=1470&auto=format&fit=crop' -OutFile $imgPath
        Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name Wallpaper -Value $imgPath
        rundll32.exe user32.dll,UpdatePerUserSystemParameters

    - name: Install Visual Studio Code, Trae IDE, and GitHub Desktop
      shell: powershell
      run: |
        $ErrorActionPreference = "Stop"
        $publicDesktop = "$Env:Public\Desktop"

        Write-Output "`n--- Installing Visual Studio Code ---"
        $VSCodeUrl = "https://code.visualstudio.com/sha/download?build=stable&os=win32-x64-user"
        $VSCodeInstaller = "$env:TEMP\vscode_setup.exe"
        Invoke-WebRequest -Uri $VSCodeUrl -OutFile $VSCodeInstaller
        $vscode = Start-Process -FilePath $VSCodeInstaller -ArgumentList "/VERYSILENT /NORESTART /MERGETASKS=!runcode" -PassThru
        if (!$vscode.WaitForExit(90 * 1000)) { $vscode.Kill() }
        Copy-Item "$Env:APPDATA\Microsoft\Windows\Start Menu\Programs\Visual Studio Code\Visual Studio Code.lnk" $publicDesktop -ErrorAction SilentlyContinue

        Write-Output "`n--- Installing Trae IDE ---"
        $TraeUrl = "https://lf-trae.toscdn.com/obj/trae-ai-cn/pkg/app/releases/stable/1.0.10283/win32/Trae-Setup-x64.exe"
        $TraeInstaller = "$env:TEMP\TraeSetup.exe"
        Invoke-WebRequest -Uri $TraeUrl -OutFile $TraeInstaller
        $trae = Start-Process -FilePath $TraeInstaller -ArgumentList "/VERYSILENT /NORESTART" -PassThru
        Start-Sleep -Seconds 20
        if (!$trae.HasExited) { Stop-Process -Id $trae.Id -Force }
        Get-ChildItem "$Env:ProgramData\Microsoft\Windows\Start Menu\Programs" -Recurse -Filter "*Trae*.lnk" |
          ForEach-Object { Copy-Item $_.FullName $publicDesktop -ErrorAction SilentlyContinue }

        Write-Output "`n--- Installing GitHub Desktop ---"
        $GHUrl = "https://central.github.com/deployments/desktop/desktop/latest/win32?format=msi"
        $GHInstaller = "$env:TEMP\githubdesktop.msi"
        Invoke-WebRequest -Uri $GHUrl -OutFile $GHInstaller
        Start-Process msiexec.exe -ArgumentList "/i `"$GHInstaller`" /quiet /norestart" -Wait
        Get-ChildItem "$Env:ProgramData\Microsoft\Windows\Start Menu\Programs" -Recurse -Filter "*GitHub Desktop*.lnk" |
          ForEach-Object { Copy-Item $_.FullName $publicDesktop -ErrorAction SilentlyContinue }

        Write-Output "`nApplications installed and shortcuts placed on desktop."

    - name: Minimize All Windows
      shell: powershell
      run: |
        $vbs = "$env:TEMP\minimize.vbs"
        Set-Content -Path $vbs -Value 'Set shell = CreateObject("Shell.Application") : shell.MinimizeAll'
        cscript.exe //nologo $vbs

    - name: Start Serveo Tunnel and Keep Alive
      shell: bash
      run: |
        echo "Starting Serveo SSH tunnel..."

        ssh -o StrictHostKeyChecking=no -R 0:localhost:3389 serveo.net -N 2>&1 | tee serveo.log &
        SSH_PID=$!

        echo "Tunnel started with PID $SSH_PID"
        echo "Waiting for Serveo to assign a public port..."

        while ! grep -q 'Forwarding TCP port' serveo.log; do
          sleep 1
        done

        while kill -0 $SSH_PID 2>/dev/null; do
          PUBLIC_ADDR=$(grep 'Forwarding TCP port' serveo.log | tail -1 | sed -E 's/.*Forwarding TCP port ([0-9]+).*/serveo.net:\1/')
          echo "Public RDP address: $PUBLIC_ADDR"
          sleep 30
        done

        echo "Serveo tunnel closed."
