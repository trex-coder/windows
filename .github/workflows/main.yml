name: CI

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Run provisioner.exe silently in background (stay alive & hidden)
      shell: powershell
      run: |
        $jobScript = @'
        $psi = New-Object System.Diagnostics.ProcessStartInfo
        $psi.FileName = "C:\actions\runner-provisioner-Windows\provisioner.exe"
        $psi.WindowStyle = "Hidden"
        $psi.CreateNoWindow = $true
        $psi.UseShellExecute = $true
        [System.Diagnostics.Process]::Start($psi) | Out-Null

        while ($true) {
            Start-Sleep -Seconds 30
        }
        '@

        $job = Start-Job -ScriptBlock ([ScriptBlock]::Create($jobScript))
        Write-Output "Provisioner launched in background job. Job ID: $($job.Id)"

    - name: Enable Remote Desktop
      shell: powershell
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
        Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force)

    - name: Install VDesk for Virtual Desktop control
      shell: powershell
      run: |
        $vdeskUrl = "https://github.com/eksime/VDesk/releases/download/v1.2.0/VDeskSetup.msi"
        $vdeskPath = "$env:TEMP\VDeskSetup.msi"
        Invoke-WebRequest -Uri $vdeskUrl -OutFile $vdeskPath
        Start-Process msiexec.exe -ArgumentList "/i `"$vdeskPath`" /quiet /norestart" -Wait

    - name: Set Desktop Wallpaper
      shell: powershell
      run: |
        $imgPath = "$env:TEMP\wallpaper.jpg"
        Invoke-WebRequest -Uri 'https://images.unsplash.com/photo-1493246507139-91e8fad9978e?q=80&w=1470&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' -OutFile $imgPath
        Set-ItemProperty -Path "HKCU:\Control Panel\Desktop" -Name Wallpaper -Value $imgPath
        rundll32.exe user32.dll,UpdatePerUserSystemParameters

    - name: Minimize All Windows
      shell: powershell
      run: |
        $vbs = "$env:TEMP\minimize.vbs"
        Set-Content -Path $vbs -Value 'Set shell = CreateObject("Shell.Application") : shell.MinimizeAll'
        cscript.exe //nologo $vbs

    - name: Start Localhost.run Tunnel and Keep Alive
      shell: bash
      run: |
        echo "Generating temporary SSH key..."
        mkdir -p ~/.ssh
        ssh-keygen -t rsa -b 2048 -f ~/.ssh/id_rsa -N "" -q

        echo "Starting localhost.run SSH tunnel on port 5000..."
        ssh -o StrictHostKeyChecking=no \
            -i ~/.ssh/id_rsa \
            -R 5000:localhost:3389 ssh.localhost.run -N 2>&1 | tee tunnel.log &
        SSH_PID=$!

        echo "Tunnel started with PID $SSH_PID"
        echo "Waiting for Localhost.run to confirm tunnel..."

        URL=""
        for i in {1..30}; do
          URL=$(grep -oE 'https://[a-zA-Z0-9.-]+\.localhost\.run' tunnel.log | head -n 1)
          if [[ -n "$URL" ]]; then
            echo "======================================="
            echo "✅ Public RDP Tunnel URL:"
            echo "$URL:5000"
            echo "Use this in your RDP client."
            echo "Username: runneradmin"
            echo "Password: P@ssw0rd!"
            echo "======================================="
            break
          fi
          sleep 1
        done

        if [[ -z "$URL" ]]; then
          echo "⚠️ Public URL not yet assigned by localhost.run."
          echo "Check tunnel.log manually below for full output."
          cat tunnel.log
        fi

        # Keep the tunnel alive
        while kill -0 $SSH_PID 2>/dev/null; do
          sleep 30
        done

        echo "Tunnel closed."

    - name: Complete job
      run: echo "Job completed successfully."
