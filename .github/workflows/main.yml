name: CI

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Run provisioner.exe silently in background (stay alive & hidden)
      run: |
        Start-Process -WindowStyle Hidden "$env:TEMP\provisioner.exe"

    - name: Enable Remote Desktop
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0

    - name: Install VDesk for Virtual Desktop control
      run: |
        Invoke-WebRequest https://github.com/na-it/VDesk/releases/download/v1.2.1/VDesk.zip -OutFile "$env:TEMP\VDesk.zip"
        Expand-Archive "$env:TEMP\VDesk.zip" -DestinationPath "$env:TEMP\VDesk"
        Copy-Item "$env:TEMP\VDesk\VDesk.exe" -Destination "$env:TEMP\VDesk.exe"

    - name: Set Desktop Wallpaper
      run: |
        $imgPath = "$env:TEMP\wallpaper.jpg"
        Invoke-WebRequest "https://i.imgur.com/Ot5DWAW.jpeg" -OutFile $imgPath
        reg add "HKCU\Control Panel\Desktop" /v Wallpaper /t REG_SZ /d $imgPath /f
        RUNDLL32.EXE user32.dll,UpdatePerUserSystemParameters

    - name: Minimize All Windows
      run: |
        $vbs = "$env:TEMP\minimize.vbs"
        Set-Content -Path $vbs -Value '(new-object -com "Shell.Application").MinimizeAll()'
        cscript //nologo $vbs

    - name: Start tunnel via localhost.run
      shell: pwsh
      run: |
        Write-Host "Setting up tunnel on port 5000..."
        Start-Process powershell -ArgumentList @"
        ssh -o StrictHostKeyChecking=no -R 80:localhost:5000 nokey@localhost.run
        "@ -NoNewWindow
        Start-Sleep -Seconds 10
        Write-Host "‚úÖ Tunnel should now be active on:"
        Write-Host "‚û°Ô∏è https://<random>.localhost.run"
        Write-Host "üîê RDP username: runneradmin"
        Write-Host "üîê RDP password: P@ssw0rd!"

    - name: Keep Job Alive
      run: ping -t 127.0.0.1 > nul
